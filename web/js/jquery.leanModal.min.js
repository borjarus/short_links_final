/**
 * Based on leanModal v1.1 by Ray Stone - http://finelysliced.com.au
 * Add AJAX support
 * @author Mirosław Puczyński
 */
(function ($) {
    $.fn.extend({
        leanModal: function (options) {
            var defaults = {
                top: 200,
                overlay: 0.5,
                closeButton: null,
                target: $(this),
                width: 600
            };
            var overlay = $("<div id='lean_overlay'></div>");
            $("body").append(overlay);
            options = $.extend(defaults, options);
            return this.each(function () {
                var o = options;
                $(this).click(function (e) {
                    var modal_id = $(this).data("id");
                    var modal_href = $(this).attr("href");
                    var target_box = $("<div class=\"modal_box\"></div>").attr( 'id', modal_id );

                    var get_ajax_html = html_query_ajax( modal_href );
                    get_ajax_html.done( function( data ) {
                        console.log( data );
                        //add data to modal
                        target_box.html( data );
                        $("body").append(target_box);
                        //append styles to modal
                        $(target_box).css({
                            "display": "block",
                            "width": o.width+"px",
                            "position": "fixed",
                            "opacity": 0,
                            "z-index": 11000,
                            "left": 50 + "%",
                            "margin-left": -(o.width / 2) + "px",
                            "top": o.top + "px"
                        });
                        $(target_box).fadeTo(200, 1);
                    });

                    $("#lean_overlay").click(function () {
                        close_modal(modal_id)
                    });
                    $(o.closeButton).click(function () {
                        close_modal(modal_id)
                    });
                    $("#lean_overlay").css({
                        "display": "block",
                        opacity: 0
                    });
                    $("#lean_overlay").fadeTo(200, o.overlay);

                    e.preventDefault()
                })
            });

            function html_query_ajax( url, args ){
                args ? args : {};
                var data = {};

                if ( args instanceof Object ){
                    for ( var arg in args ){
                        data[arg] = args[arg];
                    }
                }

                return jQuery.ajax({
                    url: url,
                    type: "POST",
                    data: data,
                    dataType: "html"
                });
            }

            function close_modal(modal_id) {
                $("#lean_overlay").fadeOut(200);
                $("#"+modal_id).remove();
            }
        }
    })
})(jQuery);